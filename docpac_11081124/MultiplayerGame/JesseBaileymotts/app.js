//////////////////////////////////////////////////////////////////
// __        __     _       __  _                   _           //
// \ \      / /___ | |__   / _|(_)  ___  _ __    __| | ___  _   //
//  \ \ /\ / // _ \| '_ \ | |_ | | / _ \| '_ \  / _` |/ __|(_)  //
//   \ V  V /|  __/| |_) ||  _|| ||  __/| | | || (_| |\__ \ _   //
//    \_/\_/  \___||_.__/ |_|  |_| \___||_| |_| \__,_||___/(_)  //
//  ____          _         _    ____   ____                    //
// / ___|  _ __  | |  __ _ | |_ |___ \ |  _ \                   //
// \___ \ | '_ \ | | / _` || __|  __) || | | |                  //
//  ___) || |_) || || (_| || |_  / __/ | |_| |                  //
// |____/ | .__/ |_| \__,_| \__||_____||____/                   //
//        |_|                                                   //
//////////////////////////////////////////////////////////////////

/*
    -------------------LYNN'S INSTRUCTIONS!!!!!!!!-------------------

    __Add a timer that starts when the game begins__
This timer will signify the end of the game when it hits 0. Players shouldn't be able to change the color of any boxes if the timer is 0

    __Add a score for each player__
The score will be calculated by the number of boxes that are the player's color

    __Alert the end of the game__
Let every player know the game has ended

    __Add a restart option__
Give players the option to restart the game

    __Add online functionality__
Ensure players from any machine can connect
*/

// Set up the variables
const { response } = require('express');
const http = require('http');
const app = require('express')();
const ws = require('websocket').server;

// Get the index.html page and listen to port 3000
app.get('/', (req, res) => res.sendFile(__dirname + '/index.html'));
app.listen(3000, console.log(`App: Listening on port 3000`));

// Create the http server 
const httpServer = http.createServer();
httpServer.listen(9090, console.log(`HTTP: Listening on port 9090`));

// Create the client hashmap for all your webfiends
const clients = {};
const games = {};

// Create the websocket server
// My socks are soggy and gross!
const wss = new ws({
    'httpServer': httpServer
});

// On connecting to the server..
wss.on('request', (request) => {
    // Connect
    const connection = request.accept(null, request.origin);
    // On opening or closing a connection, relay that. 
    connection.on('open', () => console.log('Opened'));
    connection.on('close', () => console.log('Closed'));
    // On recieving a message, JSON parse the message and save it to result
    connection.on('message', (message) => {
        // This assumes all the messages being sent by the clients are JSON which is bad practice, but for simplicities sake, I am assuming all the clients will be good little webfiends. Webfriends, if you will
        const result = JSON.parse(message.utf8Data);
        console.log(result);
        // If the method is create...
        if (result.method === 'create') {
            // Assign the client ID and the game ID
            const clientID = result.clientID;
            const gameID = guid();
            // Add the game ID to the games object
            games[gameID] = {
                'id': gameID,
                'boxes': 64,
                'clients': []
            };
            // Create the create payload 
            const payload = {
                'method': 'create',
                'game': games[gameID]
            };
            // Send the create payload for the game through the client connection
            const con = clients[clientID].connection;
            con.send(JSON.stringify(payload));
        };
        /*
        When the user creates a game,
            set the client's ID
            and create the game's ID
            Set an object for that game in the games object. Within the object,
                Set the id to the game's id.
                Set the number of boxes for the game
                Set clients to an empty client list
            Set the client of the client's list's connection to con
            Send the payload in stringified form
        */
        // If the method is join...
        if (result.method === 'join'){
            // Set the IDs and the Game
            const clientID = result.clientID;
            const gameID = result.gameID;
            const game = games[gameID];
            // If there are more than 5 players...
            if (game.clients.length >= 6) {
                // Notify that the maximum amount of players has been reached
                console.log(`Game (${gameID}) is at maximum capacity.`)
                return;
            };
            // Set the color for the player depending on which they are
            // 1 is Red, 2 is Cyan, 3 is Green, 4 is Yellow, 5 is Purple, 6 is Orange
            const color = {'0': '#ff0000', '1': '#00ffff', '2': '#00ff00', '3': '#ffff00', '4': '#ff00ff', '5': '#ff8800'}[game.clients.length]
            // Set the number for the player depending on which they are
            const player = {'0': 'Player 1', '1': 'Player 2', '2': 'Player 3', '3': 'Player 4', '4': 'Player 5', '5': 'Player 6'}[game.clients.length]
            // Add that client to the game
            game.clients.push({
                'clientID': clientID,
                'color': color,
                'player': player,
                'score': 0
            });
            // If there is more than one client, start the game
            if (game.clients.length > 1) update();
            // Create the join payload
            const payload = {
                'method': 'join',
                'game': game
            };

            // For each client in the game...
            game.clients.forEach((c) => {
                // Send a stringified payload to each client to notify that a new client has joined
                clients[c.clientID].connection.send(JSON.stringify(payload));
            });
        };
        /*
        When the user joins a game,
            set the client's ID
            and set the game's ID.
            Set the game to the game from the games object.
            if there are more than 5 players, notify that the max players has been reached.
            Set the color for the player depending on which they are.
            Set the number for the player depending on which they are.
            Push a client object to the game object.
                The client's ID should be set to the client ID
                The client's color should be set to the color
                The client's player number should be set to the player number
                The client's score should be set to 0
            If there is more than one client, call the update function
            Create the join payload
                The method should be set to join
                The game should be set to the game
            For each client in the game,
                Send the payload in stringified form
        */
        // If the method is play... 
        if (result.method === 'play') {
            // Set the IDs for the game and box, and assign the box's color
            const gameID = result.gameID;
            const boxID = result.boxID;
            const color = result.color;
            // Assign the state of the game 
            let state = games[gameID].state;
            // If there is no state, assign an empty object to state
            if (!state) state = {};
            // Assign the client's color to the box and update the game state
            state[boxID] = color;
            games[gameID].state = state;
            for (b in game[gameID].state) {
                
            }
        };
        /*
        When the user plays,
            set the ID of the game,
            set the ID of the box the user played on,
            and set the color the box should be.
            Let the state of the game be equal to the current game state.
            If the game does not have a state yet, make one.
            Assign the color to the box the player clicked.
            Assign (update) the state of that game.

            Between assigning the color to the box and updating the game state, the player's score should be increamented by one.
        */
    });
    // Generate a new client id
    const clientID = guid();
    // Where the client is in the clients object, set the connection
    clients[clientID] = {
        connection: connection
    };
    // Create the connect payload
    const payload = {
        'method': 'connect',
        'clientID': clientID
    };
    // Send the stringified payload (client connect)
    connection.send(JSON.stringify(payload));
    /*
    Generate the client's ID,
    Assign the client's connection by their ID,
    create a connect payload,
    and send that payload in stringified form
    */
});

// Create a function to update the game
let update = () => {
    // For game of games..
    // Loop through all the keys ( {'gameID':, gameID} )
    for (const g of Object.keys(games)) {
        // Set the game from the games object
        const game = games[g];
        // Create the update payload
        const payload = {
            'method': 'update',
            'game': game
        };
        // For each client in games...
        game.clients.forEach(c => {
            // Stringify and send the update payload
            clients[c.clientID].connection.send(JSON.stringify(payload));
        });
    };
    setTimeout(update, 50);
};
/*
Create a function called update. When called,
    loop through each game in games. For each,
        // Object.keys() returns an array of the object's property names
        // Object.keys(games) would returned ['gameID', 'gameID', 'gameID'] (assume the gameIDs are real ID strings)
        assign that current game to a game constant.
        Create an update payload.
        For each client in the game,
            send the stringified update payload.
    Set a time out for every 50 milliseconds (1/20th of a second) for the update function
*/

/*
    ____Example Code for a Theoretical Timer____
// Create a function to update the game
let update = () => {
    // For game of games..
    // Loop through all the keys ( {'gameID':, gameID} )
    for (const g of Object.keys(games)) {
        // Set the game from the games object
        const game = games[g];

        // Set the current time in the game
        game.time = time

        Every 1 second, the timer should tick down
        This timer should be broadcasted to each client and tick down the timer in the html
        When the timer in the game's state is 0, don't allow the players to click boxes
        Tell players who won by calculating how many boxes are the player's colors

        // Create the update payload
        const payload = {
            'method': 'update',
            'game': game
        };
        // For each client in games...
        game.clients.forEach(c => {
            // Stringify and send the update payload
            clients[c.clientID].connection.send(JSON.stringify(payload));
        });
    };
    setTimeout(update, 50);
};
*/

// Create a function to randomly create a hex string 4 characters long
const hex = () => {
    return (((1+Math.random())*0x10000)|0).toString(16).substring(1); 
};

// Create a guid (Globally Unique Identifier) by concatenating multiple random hex strings together. Ensure they are all upper case
const guid = () => (hex()/* + hex()*/ + '-' + hex()/* + hex()*/).toUpperCase();

// For anyone that needs a refresher on jolliness ðŸ‘‡
//................................................................................................................................................................................................................................
//................................................................................................................................................................................................................................
//................................................................................................................................................................................................................................
//................................................................................................................................:-==++++++++==-:................................................................................
//..............................................................................................................................-=+###%%#%%%%####*+=+++-..........................................................................
//............................................................................................................................:+#####@@@%#%%%%%%%######+=++=--....................................................................
//........................................................................................................................:-=+*####%@@@@%%#%@%@@@%%%##%%%%%%##*-..................................................................
//......................................................................................................................-+###*##%#%@@@@@@%#%@@@@%%%%@@@@@@@@@%#+-:................................................................
//....................................................................................................................-+#%%%%##%##@@@@@%%%#%@@@@%@@%@@@@@@@@%%%%%#-...............................................................
//..................................................................................................................-=#%%%%@%%%%##%@@@%%%%%@@@@@@@@@@@@@@@@%%%%####-..............................................................
//................................................................................................................:++#%%%%@@%%%%%#%%%%%@@%%%@%%%@@@@@@@@@@@@@@@%#%#+:.............................................................
//...............................................................................................................-+*#%%#%%@%@%%%#%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@%#*-.............................................................
//...............................................................................................................=##%%#%%@@@@%%%%%%%%%%%%%%#####**###%%%@%%@%%%%@@##=.............................................................
//..............................................................................................................:+#%%#%@@@@@@%%%%%%%%%%%##*+++========++#%%%%%%%%%@#+:............................................................
//.............................................................................................................-=##%%%@@%@@@@%%@@@%%%%%##*+===----==-===++*#%%%%%%#%+:............................................................
//...........................................................................................................-**+#%@@@%%@@@@@%%@@%%%%%##*+=-----------====+*#%%%%%%#+-............................................................
//.........................................................................................................:+####%%@@%%%@@@@@%%%@%%%%%%#+=-------------====+##%%%%%%#=:...........................................................
//........................................................................................................-##%%%%%%%%%%@@@@@%%%%%%#%%%#+=--------------====++#%%%%%%%*=...........................................................
//.......................................................................................................:#=:..:+##%%%@@@@%+===#%%#%%#+=--------------=--===+*#%%%%%%#+-..........................................................
//.......................................................................................................+#-.-++###%%%@@@@%+=-+=*%#%#+=----====+*+===-=--===+*###%#%%#+-:.........................................................
//......................................................................................................:**==+++*#%%%@@@@@@==+**####+==----=======*#+=---===+###%##%#*+-:.........................................................
//......................................................................................................:*##+++*#%%%%%@@@@@++*+#####+==---=+##%%##+++=====+#%%%%####*++-:.........................................................
//......................................................................................................:+#%#*###%%%%@@@@%@*++*#####+==---==+#%%+*#+=====+####%%%%##*++-:.........................................................
//.................................................................................................:==---=+=+###%%%%%%%@@@@@+=+##*#*++==----============%%%*#@%@%%##+=#=:.........................................................
//........................................................................................................::=*#%%%%#%%%%@@@@@++#*++*++====--=================#%%%##*+*#=:.........................................................
//...............................................................................................:.......:-=+==+#%%#%@%%@@@@%#*#*+++++=====--================*%%%##++%+=:.........................................................
//......................................................................................................::-:-.:=###%%%%%%@@@%#+**++++++===============--=====#@%%%%##+==..........................................................
//......................................................................................................::-=-.:##*#%@%%%%%@@%#++++++++==++==============-====@%%@%%%=+=:..........................................................
//..................................................................................................:...::-+*%#++#%%%%%%@@@@%#+++=++++++==++================#%%%%##%++-...........................................................
//..................................................................................................::...:+==:=*#%%%%%%@@@@@%#+=++==+++**+++++=============#####%#%*+=............................................................
//...................................................................................................:...:::++##%@%%@@%%%%%%##%%##*=======++*##*+**#*++==+%####%%%##*:............................................................
//...................................................................................................:..::..-=*%%##+=+%%%###=---=+##*=========+##**+*#==#%%%%%##*++++-............................................................
//..............................................................:..:.................................:..:...-++=---::------------===+#+=========+*#**=+%%%#%##*++###=:-:..........................................................
//...........................................................::::::::................................:.:.:=***=-::::::----------------===============*%%%%%###*+-**=*+:-:.........................................................
//.:......................................................::::.::::::::...............:..............::.:+++=--::::::----=====---------==+==========#%%%@%###*##===-*+=:..........................................................
//........................................................:....::::::::..............::..............::-+++---:-:---==+#########+=--------========+%%@@@@%%%#**#==--+-=+:.........................................................
//............................................................::::..:.................:..:....:......::++*=-------=+###############+=-------=+#####*####%%#%%**+%*=-===--.........................................................
//..............................::............................::::::......:........::::.......::......-*++=------+###################*=-------=#%##**++++++++++#%%%*+-=---:::.............:.......................................
//...........:..........:..::::::.:::...:.........:.:::::...:::::::::...:::.:::::::::.::::::.:::::.:::-++==+=-=-=######################+----:---=+*##++========+*%%##*+=:-:::...:..:.....::...................:................:..
//.:............::..::..:..:::..:.:::::.:::.......::.::.:..::..:::::..................................-+-**+====#########################=-----:--=+#*+=====----==#@%#+*--:::::::.::...::::::::..:::.........:::.........:::::.::.
//....................................................................................................:*--#####*#################**#####%#=--::::---=++==--------=+%@%*+=.................................................:::.....
//.....................................................................................................-*:=+*%@##################*######%%%+---::::----===---------=%@%==.........................................................
//.......................................................................................................:=#=+@##########################%%#=--:::::::---------------+%#=.........................................................
//.........................................................................................................=#=%###################%##%%##%%%#+--::::::-----------:-:--##-.........................................................
//........................................................................................................:#=#@#################%##%#%%%%#%%%#+---::::::---=----:::::--=-.........................................................
//......................................................................................................-+#--@%+###################%####%%#%%%#*+--:::::---------::::::-..........................................................
//...................................................................................................-+*+==+%%#####################%%####%%%%%###+---::::::--------:::::..........................................................
//...................................................................................................:=--=%%#%#+#################%##%##%##%%#######+-:::::::::::::-::::::.........................................................
//.....................................................................................................-*%==#-:+#################%##%#####%%%#######+--:::::::::::::::::::........................................................
//.....................................................................................................:#++=%=-+###################%#%%%##%%#%%%#####*=-:::::::::::::::::::.......................................................
//......................................................................................................:=#%-*+*****####################%##%%#########*+--::::::::::::::::........................................................
//.........................................................................................................=*+-+#**##########%%##########%#%%##*#########+--:::::::::::::::.......................................................
//......................:..................................................................................:.+--##########################%#%#############*=--:::::::::::.........................................................
//................:-*########+-..............................................................................+:-#################%##%###%##%%%%%%############+--:::::::::.:.......................................................
//..............-#=:.....:=#####+:.........................................................................:+:+==###################%%%##%##%%#################=-::::::::::.......................................................
//............-#-...........:*####-......:-*-......:....................................................:---::..:*#####################%##%#%%##%###############=---:::::::.......................................................
//...........=*:..............=####=...-*#####=..:+##*-:::-*-....................................................+#################%########%%%%################*=-----::-:.......................................................
//..........-*:................=####+*=:..:*####=+-+####*-+-.....................................................-##########%###########%##%#%%%%%#%###############*++=-++-.......................................................
//.........-#=.................:*####:.....:*###+.......:+=................:......................................+#####################%##%#%##%%#%##%###################:.......................................................
//.........+#-......:*###*-.....-####+......=####:......+*:...............*--.....................................-################%%#%#######%%%###%####################*:.......................................................
//........:*#-......--:-+##=.....*####:.....-####:.....=#-...............:#-.......................................+############%####%#######%%%%#########################-.......................................................
//........:*#+...........+#+.....=####-.....-###+.....-#*..-==+:-+:+---=--#==:.=---==-:-=:*=.#-%:-.................-#########################%%%%#######%#%###############-.......................................................
//.........+##-..........-#-.....-####-.....-###=....:*#+...=--..-::-:---:-.-...--.-:-..-::-::-%:..................:+##################%######%%%%%#%%#%%#%###############-.......................................................
//.........=###-.........++......-####=.....-###-....=##=....................................=:+....................-##########%##############%%%%###%####################=.......................................................
//..........=###+-.....-+-.......:####-.....-###:...:*##=....................................::.....................:*#########################%%###%%#%#%%###########%%##+.......................................................
//...........:*########-.........:####-.....-##-....-###--=+*##*+-:..................................................-####%###%########%#######%%%%%%#%%##############%%###:......................................................
//................:..............-####:.....=#+.....=###+-::-+#####+.................................................:*##########%%######%#####%%#%%##%%%%%##########%%%##%-......................................................
//...............................=###=......++.....:*###-.......-###+.................................................=###############%#########%%%%%%%##%%##########%%%%%#=......................................................
//...............................+##*......+-....:*-+###-........:*##-................................................:##############%###%######%%%%%%%###%%#########%%%%%#*......................................................
//..............................:###-...........-#:.+###=.........-##-.................................................=####%###########%#####%###%%%%%%%%%%########%%%%%%##:.....................................................
//..............................+##=...........+#:..=###+.........:##:.................................................-###########%##############%%%%#%##%#%#######%%%%%###-.....................................................
//:...........+####+:..........=##=...........+#-...-###*:........-#-..................................................:*###########%##############%%%%%%##%########%%%%####+.....................................................
//:..........=###-............-##-..........:+#+....:*###=........+=....................................................=#####%######################%%%%%#%########%%%%%%##*:....................................................
//...........=#*:...........:=#+:...........=##:.....=####-.....:+-.....................................................-##%###########%######%######%%#%##########%%%%%%%###:....................................................
//:..........-#+..........:=#+:............-##+.......+####-::-*+.......................................................-##################%###########%%%#########%%%%%#####-....................................................
//:...........:=*=-:::-=+*+-...............+##=........=#####*=.........................................................=###########%%#%##%###########%%%#%%#######%%%%%##%##-....................................................
//.................:::....................:###=...........:............................................................:+###**#################%#%#######%%%%######%%%%%%####-....................................................
//........................................-###=...--..................................................................:-####***#####%%#########%###%####%%%#######%%%####%###=....................................................
//........................................=###+..=-=....:=....:=......................................................+%%%%#*###########################%%%%%####%%%%%%%%####=....................................................
//:.................:::.:..:.::..::.:.:...=###*..==:.::..-.::.-=.:::::.:::.-:........................................:#%%%%%%@@%%#%%#########%##%####%###%%@%%#*%%@%%%%%%#%##=....................................................
//..................*-%:#:*=:-==--+:*:+::.-####-.=:+::=:=*:=+--=:%:%:#:+:+-:=.:......................................=%#%%%@@@@@%%%@#*###################%@@@#@@@%@%%%%%%####=....................................................
//...................................-+...:####+....................................................................:#%%%%%@@@@%%#%@@%#####*##############%@%@@@%+@%%%%%%####=....................................................
//.................................:=--....+####-...................................................................=#%@%@@@@@%%%#@@@@%######%##%%##%###%#@@%@@%#*@%%%%%%%###=....................................................
//.........................................:*###*:.....................==...........................................=##%%%@@@@%%%%@@@@@%#######%#%%#%#####%%*@%%##@%%%%%#####=....................................................
//..........................................:####*:...................==...........................................-#####%%%%%%%@@@@@@@@##########%##%######%%%%*#@%%%%#%####=....................................................
//............................................+####-................:=-...........................................-###########%%%%%%%%@@@%############%#####%%%%*%@%%%%%#####+....................................................
//.............................................:+###+:............:==:...........................................:*#####*#######%%#%%%%%%%%#####%%##%#%%####%@%%%%%%%%%%######-...................................................
//...............................................:=*###=-:....::=+=:............................................:+#########%##%###%%##%%%%%%#######%%##%%####%%###%%##%%######=...................................................
//:..................................................:-==++++=-:................................................=##############%##%#####%%%%%%#####%%##%#%%###%##+*##*###*+==-:...................................................
//.............................................................................................................=##########%#####%####%##%%%%%%%%%%####%%#%%####%*+=++====---:::...................................................
//............................................................................................................:*###############%%%#%#%%%#%%#%%%%##%####%##%#####++=-------:::::...................................................
//...........................................................................................................:+########*#############%%#%#%%%%%%%%##############+==-----::::::::..................................................
//...........................................................................................................-################%###%%##%#%%%%%%%%%%%%%##%########*=-----::::::::...................................................
//:.........................................................................................................:+###############################%%%%%%####%%%%######*----:::::::::::.................................................
//:.........................................................................................................-#####*###################%%##%%%#%%%%%%%%#######%%###--:::::::::::::.................................................
//:.........................................................................................................+##############################%###%%%%%%%%%%%#%%##%#=--:::::::::::::::...............................................
//.........................................................................................................:+*####################*++#######***##%%%%%%%%#%###**=--::::::::::::::::...............................................
//.........................................................................................................:*###################%###############%%%%%####%###++=--:::::::::::::::.................................................
//:........................................................................................................-*###################%#################%%%#++=++++----::::::::::::::...................................................
//.........................................................................................................:*#########################################+=-------:::::::::::::::--..................................................
//:........................................................................................................:*################%##################%%######*=---::::::::::::::::--*#=:...............................................
//..........................................................................................................+#############################################+-----:::::::::::----*###*-.............................................
//..........................................................................................................=##############################################*==-----:::::::-----=#####*=:..........................................
//..........................................................................................................-################################################*##==-----------=--######*+=:........................................
//...........................................................................................................+######################################################+==--=------+########*+-......................................
//...........................................................................................................-##########################################################+====---=###########+-....................................
//:.....................................................................................................::....=###########################################################*+==---############*+-..................................
//...................................................................................................::::.::::.+#############################################################+==--##############*-................................
//......................................................................................................::::--.:+##*###########################################################+===%##############*-..............................
//....................................................................................................:.:::::---:*#######*#################################################*+*#**=+%#############*#*+-............................
//.....................................................................................................::::::::---+##########################*+##################################*+%###########**#****+:..........................
//........................................................................................................::::::---=#################################################################%#########*##******=:........................
//.....................................................................................................::..::::::---=+########################*########################################################*#*-::::...................
//.......................................................................................................:::.:::::---==*%############################################################**###################+-:::::.................
//....:..................................................................................................:..:::::::--=---+###############################################################################*++=-::::................
//........................................................................................................::::::::----------=++*##########################################################*###############**+=-:::................
//.....................................................................................................:::::.::::.....::.:--------=*########################################################*##############**-:.:.................
//.::.................................................................................................:...................::::::::::::--=+#######################################**##*####*+****#######+=-:-=:....................
//...:....................................................................................................................:......:::.......:+####*#############################*#*#*###**###**#*-+++=-:...........................
//..........................................................................................................................................:.:::::+-:-+####+=.:+###################**##*#######+=-...............................
//::..:...................................................................................................................................................-=:....:########*######+##**###+#*###+*+:...............................
//.:................................................................................................................................................................:..:+##########*#**####**##*#=................................
//.......................................................................................................................................................................:-+##*#**====**=+*++=-:..................................